name: PR must link an Issue + Auto-label Issues

on:
  pull_request:
    types:
      - opened
      - edited
      - synchronize
      - ready_for_review
      - reopened
      - converted_to_draft
      - closed

permissions:
  contents: read
  issues: write
  pull-requests: read

jobs:
  enforce-and-label:
    runs-on: ubuntu-latest
    steps:
      - name: Parse PR body for linked issues (Fixes/Closes/Resolves)
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.pull_request.body || "";
            // Case-insensitive: Fixes #123, Closes #1, Resolves #999
            const closeRegex = /(?:close[sd]?|fixe?[sd]?|resolve[sd]?)\s+#(\d+)/gi;
            const allIssueIds = [];
            for (const m of body.matchAll(closeRegex)) {
              allIssueIds.push(Number(m[1]));
            }
            core.setOutput("issue_ids", JSON.stringify(allIssueIds));
            core.setOutput("has_link", String(allIssueIds.length > 0));

      - name: Require a linked issue
        if: ${{ steps.parse.outputs.has_link != 'true' && github.event.action != 'closed' }}
        run: |
          echo "❌ PR must reference an issue using 'Fixes #<number>' (or Closes/Resolves)."
          exit 1

      - name: Add 'status:in-review' when PR is opened / ready
        if: >
          ${{
            (github.event.action == 'opened' ||
             github.event.action == 'ready_for_review' ||
             github.event.action == 'reopened') &&
            steps.parse.outputs.has_link == 'true'
          }}
        uses: actions/github-script@v7
        with:
          script: |
            const issueIds = JSON.parse(core.getInput('issue_ids', { required: true }));
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            for (const id of issueIds) {
              await github.rest.issues.addLabels({ owner, repo, issue_number: id, labels: ['status:in-review'] }).catch(()=>{});
              // Optional tidy-up: remove "status:in-progress" if present
              try {
                await github.rest.issues.removeLabel({ owner, repo, issue_number: id, name: 'status:in-progress' });
              } catch {}
            }
          result-encoding: string
          issue_ids: ${{ steps.parse.outputs.issue_ids }}

      - name: Switch to 'status:in-progress' when PR becomes draft
        if: ${{ github.event.action == 'converted_to_draft' && steps.parse.outputs.has_link == 'true' }}
        uses: actions/github-script@v7
        with:
          script: |
            const issueIds = JSON.parse(core.getInput('issue_ids', { required: true }));
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            for (const id of issueIds) {
              await github.rest.issues.addLabels({ owner, repo, issue_number: id, labels: ['status:in-progress'] }).catch(()=>{});
              try { await github.rest.issues.removeLabel({ owner, repo, issue_number: id, name: 'status:in-review' }); } catch {}
              try { await github.rest.issues.removeLabel({ owner, repo, issue_number: id, name: 'status:done' }); } catch {}
            }
          issue_ids: ${{ steps.parse.outputs.issue_ids }}

      - name: Mark issue done when PR merges
        if: ${{ github.event.action == 'closed' && github.event.pull_request.merged == true && steps.parse.outputs.has_link == 'true' }}
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const issueIds = JSON.parse(core.getInput('issue_ids', { required: true }));
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            for (const id of issueIds) {
              await github.rest.issues.addLabels({ owner, repo, issue_number: id, labels: ['status:done'] }).catch(()=>{});
              try { await github.rest.issues.removeLabel({ owner, repo, issue_number: id, name: 'status:in-review' }); } catch {}
              // Nice breadcrumb on the issue
              await github.rest.issues.createComment({
                owner, repo, issue_number: id,
                body: `✅ Merged in PR #${prNumber}. Closing via PR.`
              }).catch(()=>{});
            }
          issue_ids: ${{ steps.parse.outputs.issue_ids }}

      - name: Re-opened (non-merged) PR → ensure 'status:in-review'
        if: ${{ github.event.action == 'reopened' && steps.parse.outputs.has_link == 'true' }}
        uses: actions/github-script@v7
        with:
          script: |
            const issueIds = JSON.parse(core.getInput('issue_ids', { required: true }));
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            for (const id of issueIds) {
              await github.rest.issues.addLabels({ owner, repo, issue_number: id, labels: ['status:in-review'] }).catch(()=>{});
              try { await github.rest.issues.removeLabel({ owner, repo, issue_number: id, name: 'status:done' }); } catch {}
            }
          issue_ids: ${{ steps.parse.outputs.issue_ids }}
